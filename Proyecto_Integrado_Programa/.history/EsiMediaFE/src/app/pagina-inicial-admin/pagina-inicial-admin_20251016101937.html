<div class="full-screen-wrapper">
  <div class="page-wrapper">
    <nav class="navbar">
      <ul class="navbar-options">
        <li><a class="active">ğŸ‘¥ GestiÃ³n de Usuarios</a></li>
      </ul>
      <div class="user-panel">
        <div class="user-photo" [title]="userName">
          <img *ngIf="userAvatarUrl; else initialsTpl" [src]="userAvatarUrl" alt="Avatar" (error)="onAvatarError()" />
          <ng-template #initialsTpl><span class="user-photo-fallback">{{ userInitials }}</span></ng-template>
        </div>
        <div class="user-info">
          <div class="user-name">{{ userName }}</div>
          <div class="user-email">{{ userEmail }}</div>
          <div class="user-role">ğŸ›¡ï¸ {{ userRole }}</div>
        </div>
        <button class="logout-btn" disabled>ğŸšª Salir</button>
      </div>
    </nav>

    <div class="main-container">
      <aside class="filter-panel">
        <h3>ğŸ” Filtros</h3>
        <form (submit)="$event.preventDefault()">
          <div class="filter-section">
            <label for="nombre">ğŸ”¤ BÃºsqueda</label>
            <input id="nombre" type="text" name="nombre" [(ngModel)]="filtros.nombre" (ngModelChange)="onSearchChange()" placeholder="Alias, nombre, apellidos, email" />
          </div>
          <div class="filter-section">
            <label for="tipo">ğŸ§© Tipo de usuario</label>
            <select id="tipo" name="tipo" [(ngModel)]="filtros.tipo" (ngModelChange)="onTipoChange()">
              <option value="">Todos</option>
              <option value="ADMINISTRADOR">Administradores</option>
              <option value="GESTOR_CONTENIDO">Creadores</option>
              <option value="USUARIO">Usuarios</option>
            </select>
          </div>
          <div class="filter-section">
            <label for="bloqueado">ğŸ” Estado</label>
            <select id="bloqueado" name="bloqueado" [(ngModel)]="filtros.bloqueado" (ngModelChange)="onStateChange()">
              <option value="">Todos</option>
              <option value="no">Activos</option>
              <option value="si">Bloqueados</option>
            </select>
          </div>
          <div class="filter-section">
            <label for="vip">â­ VIP</label>
            <select id="vip" name="vip" [(ngModel)]="filtros.vip" (ngModelChange)="onVipChange()">
              <option value="">Cualquiera</option>
              <option value="si">SÃ­</option>
              <option value="no">No</option>
            </select>
          </div>
          <div class="filter-section">
            <label for="ordenar">â†•ï¸ Ordenar</label>
            <select id="ordenar" name="ordenar" [(ngModel)]="filtros.ordenar" (ngModelChange)="onOrderChange()">
              <option value="fecha">ğŸ—“ï¸ Fecha</option>
              <option value="nombre">ğŸ”  Nombre</option>
              <option value="rol">ğŸ·ï¸ Rol</option>
              <option value="vip">â­ VIP</option>
            </select>
          </div>
        </form>
      </aside>

      <main class="content-area">
        <section>
          <h3>ğŸ›ï¸ AdministraciÃ³n</h3>
          <button type="button" class="action-btn btn-edit" (click)="openCreateAdmin()">â• Nuevo administrador</button>

          <div class="spinner" *ngIf="loading"><div class="loader"></div><span>â³ Cargando...</span></div>
          <div class="alert error" *ngIf="!loading && errorMsg">âŒ {{ errorMsg }}</div>
          <div class="empty" *ngIf="!loading && !errorMsg && filteredUsers.length === 0">ğŸ•µï¸â€â™‚ï¸ Sin resultados</div>

          <div class="table-wrap" *ngIf="!loading && !errorMsg && filteredUsers.length > 0">
            <table class="users-table">
              <thead>
                <tr>
                  <th>ğŸ–¼ï¸ Avatar</th>
                  <th>ğŸ§‘ Alias</th>
                  <th>ğŸ“ Nombre</th>
                  <th>ğŸ“§ Email</th>
                  <th>ğŸ·ï¸ Rol</th>
                  <th>ğŸ” Estado</th>
                  <th>â­ VIP</th>
                  <th style="width:260px">ğŸ› ï¸ Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let u of pageItems; trackBy: trackUser">
                  <td>
                    <span class="user-photo-small">
                      <img *ngIf="u.fotoUrl; else initialsFallback" [src]="u.fotoUrl" alt="avatar" (error)="u.fotoUrl=null" />
                      <ng-template #initialsFallback><span class="user-photo-fallback">{{ (u.alias || u.nombre || 'U')[0] | uppercase }}</span></ng-template>
                    </span>
                  </td>
                  <td>{{ u.alias }}</td>
                  <td>{{ u.nombre }}</td>
                  <td>{{ u.email }}</td>
                  <td>{{ u.role }}</td>
                  <td>
                    <span class="status-badge" [class.status-badge--green]="!u.blocked" [class.status-badge--red]="u.blocked" [title]="u.blocked ? 'Bloqueado' : 'Activo'">
                      {{ u.blocked ? 'ğŸ”’' : 'ğŸ”“' }}
                    </span>
                  </td>
                  <td class="vip-cell">
                    <ng-container *ngIf="isUser(u); else noVipCell">
                      <span class="status-badge" [class.status-badge--green]="!!u.vip" [class.status-badge--red]="!u.vip" [title]="u.vip ? 'VIP' : 'No VIP'">
                        {{ u.vip ? 'â­' : 'â˜†' }}
                      </span>
                    </ng-container>
                    <ng-template #noVipCell>â€”</ng-template>
                  </td>
                  <td class="actions-cell">
                    <button type="button" class="action-btn btn-edit" [disabled]="!isAdmin(u) || isSuperAdmin(u)" (click)="openEditAdminModal(u)" title="Editar">âœï¸</button>
                    <button type="button" class="action-btn btn-block" [disabled]="!isAdmin(u) || isSuperAdmin(u)" (click)="toggleBlockUser(u)" [title]="u.blocked ? 'Desbloquear' : 'Bloquear'">
                      {{ u.blocked ? 'ğŸ”“' : 'ğŸ”’' }}
                    </button>
                    <button type="button" class="action-btn btn-consult" [disabled]="!isAdmin(u) || isSuperAdmin(u)" (click)="deleteUser(u)" title="Eliminar">ğŸ—‘ï¸</button>
                  </td>
                </tr>
              </tbody>
            </table>

            <div class="pager">
              <button type="button" (click)="goto(page-1)" [disabled]="page<=1">Â«</button>
              <span>ğŸ“„ PÃ¡gina {{ page }} / {{ totalPages }}</span>
              <button type="button" (click)="goto(page+1)" [disabled]="page>=totalPages">Â»</button>
              <select [(ngModel)]="pageSize" (change)="goto(1)">
                <option [ngValue]="5">5</option>
                <option [ngValue]="10">10</option>
                <option [ngValue]="20">20</option>
                <option [ngValue]="50">50</option>
              </select>
            </div>
          </div>
        </section>

        <div class="modal" *ngIf="showCreateAdminModal">
          <div class="modal-content">
            <span class="close" (click)="cancelCreateAdmin()" title="Cerrar">âœ–ï¸</span>
            <h3 style="margin-top:0">â• Nuevo administrador</h3>
            <form #createAdminForm="ngForm" (ngSubmit)="createAdmin(createAdminForm)">
              <div class="filter-section"><label>Nombre</label><input name="nombre" [(ngModel)]="crearAdmin.nombre" required minlength="2" maxlength="100" /></div>
              <div class="filter-section"><label>Apellidos</label><input name="apellidos" [(ngModel)]="crearAdmin.apellidos" required minlength="2" maxlength="120" /></div>
              <div class="filter-section">
                <label>Alias</label>
                <div class="alias-row">
                  <input name="alias" [(ngModel)]="crearAdmin.alias" required minlength="2" maxlength="50" (ngModelChange)="onAliasChangeCreate($event)" />
                  <div class="alias-status">
                    <span class="spinner" *ngIf="aliasChecking"></span>
                    <span *ngIf="!aliasChecking && aliasAvailable === true" class="chip-ok">Disponible</span>
                    <span *ngIf="!aliasChecking && aliasAvailable === false" class="chip-bad">No disponible</span>
                  </div>
                </div>
              </div>
              <div class="filter-section"><label>Email</label><input type="email" name="email" [(ngModel)]="crearAdmin.email" required maxlength="180" /></div>
              <div class="filter-section"><label>ContraseÃ±a</label><input type="password" name="pwd" [(ngModel)]="crearAdmin.pwd" required minlength="8" /></div>
              <div class="filter-section"><label>Repetir contraseÃ±a</label><input type="password" name="pwd2" [(ngModel)]="crearAdmin.pwd2" required minlength="8" /><small class="error-msg" *ngIf="pwdMismatchCreate">Las contraseÃ±as no coinciden</small></div>
              <div class="filter-section"><label>Departamento</label><input name="departamento" [(ngModel)]="crearAdmin.departamento" required maxlength="120" /></div>
              <div class="filter-section"><label>Foto (URL)</label><input name="foto" [(ngModel)]="crearAdmin.foto" maxlength="500" /></div>
              <div class="filter-section"><label>Fecha de nacimiento</label><input type="date" name="fechaNac" [(ngModel)]="crearAdmin.fechaNac" /></div>
              <div class="modal-actions" style="margin-top:20px">
                <button class="action-btn btn-edit" type="submit" [disabled]="createAdminForm.invalid || aliasAvailable===false || pwdMismatchCreate || loading">{{ loading ? 'Creandoâ€¦' : 'Crear' }}</button>
                <button class="action-btn btn-consult" type="button" (click)="cancelCreateAdmin()">Cancelar</button>
              </div>
            </form>
          </div>
        </div>

        <div class="modal" *ngIf="showEditAdminModal">
          <div class="modal-content">
            <span class="close" (click)="cancelEditAdmin()" title="Cerrar">âœ–ï¸</span>
            <h3 style="margin-top:0">âœï¸ Editar administrador</h3>
            <form #editAdminForm="ngForm" (ngSubmit)="saveAdminEdit(editAdminForm)">
              <div class="filter-section"><label>Alias</label><input name="alias" [(ngModel)]="adminEditModel.alias" required minlength="2" maxlength="50" (ngModelChange)="onAdminAliasInput($event)" /><div class="help error" *ngIf="adminAliasTaken">Alias en uso</div></div>
              <div class="filter-section"><label>Nombre</label><input name="nombre" [(ngModel)]="adminEditModel.nombre" required minlength="2" maxlength="100" /></div>
              <div class="filter-section"><label>Apellidos</label><input name="apellidos" [(ngModel)]="adminEditModel.apellidos" maxlength="120" /></div>
              <div class="filter-section"><label>Email</label><input type="email" name="email" [(ngModel)]="adminEditModel.email" required maxlength="180" /></div>
              <div class="filter-section">
                <label>Avatar</label>
                <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                  <div *ngIf="adminEditModel.fotoPreviewUrl" style="display:flex;align-items:center;gap:10px">
                    <img [src]="adminEditModel.fotoPreviewUrl" alt="avatar preview" style="width:72px;height:72px;border-radius:50%;object-fit:cover;border:1px solid #444" />
                  </div>
                  <input name="foto" [(ngModel)]="adminEditModel.foto" placeholder="URL" />
                  <small *ngIf="!adminEditModel.fotoPreviewUrl" style="color:#bbb">Sin avatar</small>
                </div>
              </div>
              <div class="modal-actions" style="margin-top:20px">
                <button class="action-btn btn-edit" type="submit" [disabled]="editAdminForm.invalid || adminAliasTaken || loading">{{ loading ? 'Guardandoâ€¦' : 'Guardar' }}</button>
                <button class="action-btn btn-consult" type="button" (click)="cancelEditAdmin()">Cancelar</button>
              </div>
            </form>
          </div>
        </div>

        <div class="modal" *ngIf="showConfirmModal">
          <div class="modal-content">
            <span class="close" (click)="cancelConfirm()" title="Cerrar">âœ–ï¸</span>
            <h3 style="margin-top:0">â“ ConfirmaciÃ³n</h3>
            <p *ngIf="confirmKind==='block'">Â¿Bloquear a <strong>{{ targetUser?.alias }}</strong>?</p>
            <p *ngIf="confirmKind==='unblock'">Â¿Desbloquear a <strong>{{ targetUser?.alias }}</strong>?</p>
            <p *ngIf="confirmKind==='delete'">Â¿Eliminar a <strong>{{ targetUser?.alias }}</strong>?</p>
            <div class="modal-actions" style="margin-top:20px">
              <button class="action-btn btn-edit" type="button" (click)="confirmAction()">Aceptar</button>
              <button class="action-btn btn-consult" type="button" (click)="cancelConfirm()">Cancelar</button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>
</div>
