<div class="auth-container">
  <h2>
    {{ esAltaAdmin ? 'Nuevo Administrador' : (esAltaCreador ? 'Nuevo Creador' : 'Crear Cuenta') }}
  </h2>

  <div class="info-banner" *ngIf="esAltaCreador">
    <p>
      Alta realizada por <b>Administrador</b>. El rol queda fijado a
      <span class="chip-role">Gestor de Contenido</span>.
      No se requieren fecha de nacimiento ni aceptaci√≥n de t√©rminos.
    </p>
  </div>
  <div class="info-banner info-banner--admin" *ngIf="esAltaAdmin">
    <p>
      Alta de <b>Administrador</b>. El rol queda fijado a
      <span class="chip-role chip-role--admin">Administrador</span>.
      No se requieren fecha de nacimiento, aceptaci√≥n de t√©rminos ni contrase√±a.
    </p>
  </div>

  <form #f="ngForm" (ngSubmit)="onSubmit(f)">
    <input class="input"
      name="nombre"
      [(ngModel)]="nombre"
      required
      #nombreModel="ngModel"
      (ngModelChange)="0"
      [ngClass]="{
        'input-error': nombreModel.invalid && nombreModel.dirty,
        'input-valid': nombreModel.valid && nombreModel.dirty
      }"
      placeholder="Nombre *">
    <small class="error-msg" *ngIf="nombreModel.invalid && nombreModel.dirty">Falta el nombre</small>

    <input class="input"
      name="apellidos"
      [(ngModel)]="apellidos"
      required
      #apellidosModel="ngModel"
      (ngModelChange)="0"
      [ngClass]="{
        'input-error': apellidosModel.invalid && apellidosModel.dirty,
        'input-valid': apellidosModel.valid && apellidosModel.dirty
      }"
      placeholder="Apellidos *">
    <small class="error-msg" *ngIf="apellidosModel.invalid && apellidosModel.dirty">Faltan los apellidos</small>

    <input class="input"
      type="email"
      name="email"
      [(ngModel)]="email"
      required
      [pattern]="emailPattern.source"
      #emailModel="ngModel"
      (ngModelChange)="0"
      [ngClass]="{
        'input-error': emailModel.invalid && emailModel.dirty,
        'input-valid': emailModel.valid && emailModel.dirty
      }"
      placeholder="Email *">
    <small class="error-msg" *ngIf="emailModel.errors?.['required'] && emailModel.dirty">Falta el email</small>
    <small class="error-msg" *ngIf="emailModel.errors?.['pattern'] && emailModel.dirty">Email no v√°lido</small>

    <div class="alias-row">
      <input class="input"
        name="alias"
        [(ngModel)]="alias"
        required
        #aliasModel="ngModel"
        (ngModelChange)="onAliasChange()"
        [ngClass]="{
          'input-error': (aliasModel.invalid && aliasModel.dirty) || (!!alias && aliasUnique === false),
          'input-valid': !!alias && aliasUnique === true
        }"
        placeholder="Alias * (√∫nico)">
      <div class="alias-status">
        <span class="spinner" *ngIf="isCheckingAlias"></span>
        <span *ngIf="!isCheckingAlias && !!alias && aliasUnique === true" class="chip-ok">Disponible</span>
        <span *ngIf="!isCheckingAlias && !!alias && aliasUnique === false" class="chip-bad">No disponible</span>
      </div>
    </div>
    <small class="error-msg" *ngIf="aliasModel.errors?.['required'] && aliasModel.dirty">Falta el alias</small>
    <small class="error-msg" *ngIf="!!alias && !isCheckingAlias && aliasUnique === false">El alias ya existe. Elige otro.</small>

    <div class="fila-fecha" *ngIf="!esAltaCreador && !esAltaAdmin">
      <input class="input"
        type="date"
        name="fechaNac"
        [(ngModel)]="fechaNac"
        required
        #fechaModel="ngModel"
        (ngModelChange)="0"
        [ngClass]="{
          'input-error': (fechaModel.invalid && fechaModel.dirty) || fechaInvalida,
          'input-valid': fechaModel.valid && !fechaInvalida
        }"
        placeholder="Fecha de nacimiento *">
      <small class="error-msg" *ngIf="fechaModel.errors?.['required'] && fechaModel.dirty">Falta la fecha</small>
      <small class="error-msg" *ngIf="fechaInvalida">La fecha no puede ser futura</small>
    </div>
    <ng-container *ngIf="!esAltaCreador && !esAltaAdmin">
      <select class="input role-select"
        name="role"
        [(ngModel)]="role"
        required
        #roleModel="ngModel"
        (ngModelChange)="onRoleChange($event)"
        [disabled]="roleDisabled"
        [ngClass]="{
          'input-error': roleModel.invalid && roleModel.dirty,
          'input-valid': roleModel.valid && roleModel.dirty
        }">
        <option value="" disabled selected>Selecciona un rol *</option>
        <option value="usuario">Usuario</option>
        <option value="Gestor de Contenido">Gestor de Contenido</option>
      </select>
      <small class="error-msg" *ngIf="roleModel.invalid && roleModel.dirty">Selecciona un rol</small>
    </ng-container>
    <div class="role-chip-row" *ngIf="esAltaCreador">
      <span class="chip-role">Rol: Gestor de Contenido</span>
    </div>
    <div class="role-chip-row" *ngIf="esAltaAdmin">
      <span class="chip-role chip-role--admin">Rol: Administrador</span>
    </div>
    <div *ngIf="isGestor" class="gestor-extra">
      <textarea class="input"
        name="descripcion"
        [(ngModel)]="descripcion"
        required
        placeholder="Descripci√≥n * (obligatoria para Gestor de Contenido)"></textarea>
      <small class="error-msg" *ngIf="isGestor && !descripcion?.trim()">Falta la descripci√≥n</small>

      <input class="input"
        name="especialidad"
        [(ngModel)]="especialidad"
        required
        placeholder="Especialidad *">
      <small class="error-msg" *ngIf="isGestor && !especialidad?.trim()">Falta la especialidad</small>

      <div class="tipo-row">
        <label class="tipo-label" for="tipoContenido">Tipo de contenido * </label>
        <label class="tipo-chip">
          <input id="tipoContenido" type="radio" name="tipoContenido" [(ngModel)]="tipoContenido" [value]="'Audio'"> Audio
        </label>
        <label class="tipo-chip">
          <input type="radio" name="tipoContenido" [(ngModel)]="tipoContenido" [value]="'Video'"> Video
        </label>
      </div>
      <small class="error-msg" *ngIf="isGestor && !(tipoContenido==='Audio' || tipoContenido==='Video')">Selecciona Audio o Video</small>
    </div>

    <!-- Campo Departamento (solo Admin) -->
    <div class="field" *ngIf="esAltaAdmin">
      <input class="input"
        name="departamento"
        [(ngModel)]="departamento"
        required
        maxlength="120"
        placeholder="Departamento * (p. ej. Sistemas / Direcci√≥n TI)"
        #depModel="ngModel"
        [ngClass]="{
          'input-error': depModel.invalid && depModel.dirty,
          'input-valid': depModel.valid && depModel.dirty
        }">
      <small class="error-msg" *ngIf="depModel.invalid && depModel.dirty">El departamento es obligatorio.</small>
    </div>

    <!-- CONTRASE√ëAS: solo si no es admin -->
    <ng-container *ngIf="showPasswordFields">
      <div class="password-field">
        <input class="input"
          [type]="showPwd ? 'text' : 'password'"
          name="pwd"
          [(ngModel)]="pwd"
          required
          minlength="8"
          #pwdModel="ngModel"
          (ngModelChange)="onPwdChange()"
          [ngClass]="{
            'input-error': (pwdModel.invalid && pwdModel.dirty) || (pwdModel.dirty && pwdIssues.length>0),
            'input-valid': pwdModel.valid && pwdIssues.length==0
          }"
          placeholder="Contrase√±a *">
        <button type="button" class="toggle-eye" (click)="togglePwd()">{{ showPwd ? 'üôà' : 'üëÅÔ∏è' }}</button>
      </div>

      <ul class="error-list" *ngIf="pwdModel.dirty && pwdIssues.length">
        <li *ngFor="let r of pwdIssues" class="error-msg">‚Ä¢ {{ r }}</li>
      </ul>

      <div class="strength-wrapper" *ngIf="pwdModel.dirty || pwd">
        <div class="strength-bar"
             [ngClass]="{
               's1': pwdScore <= 1,
               's2': pwdScore === 2,
               's3': pwdScore === 3,
               's4': pwdScore >= 4
             }"></div>
        <div class="strength-label">Fortaleza: <b>{{ pwdStrengthLabel }}</b></div>
      </div>

      <div class="strength-label" aria-live="polite" *ngIf="hasPwd">
        <span class="spinner" *ngIf="isCheckingPwned"></span>
        <small *ngIf="!isCheckingPwned && pwnedSeverity==='warn'"
               class="error-msg"
               [innerHTML]="pwnedMessage"></small>
        <small *ngIf="!isCheckingPwned && pwnedSeverity==='ok'"
               style="color:#00ff80"
               [innerHTML]="pwnedMessage"></small>
        <small *ngIf="!isCheckingPwned && pwnedSeverity==='unknown' && pwnedMessage"
               style="color:rgba(255,255,255,0.8)">{{ pwnedMessage }}</small>
      </div>

      <div class="password-field">
        <input class="input"
          [type]="showPwd2 ? 'text' : 'password'"
          name="pwd2"
          [(ngModel)]="pwd2"
          required
          #pwd2Model="ngModel"
          (ngModelChange)="0"
          [ngClass]="{
            'input-error': (pwd2Model.invalid && pwd2Model.dirty) || (pwd2Model.dirty && pwdMismatch),
            'input-valid': pwd2Model.valid && !pwdMismatch
          }"
          placeholder="Repetir Contrase√±a *">
        <button type="button" class="toggle-eye" (click)="togglePwd2()">{{ showPwd2 ? 'üôà' : 'üëÅÔ∏è' }}</button>
      </div>
      <small class="error-msg" *ngIf="pwdMismatch">Las contrase√±as no coinciden</small>
    </ng-container>

    <div class="avatar-row">
      <button type="button" class="btn" (click)="openAvatarModal()">Elegir Avatar</button>
    </div>

    <div *ngIf="selectedAvatar" class="selected-avatar-card">
      <img [src]="selectedAvatar" alt="avatar" class="selected-avatar-card__img">
      <div class="selected-avatar-card__text">
        <b>Avatar seleccionado</b>
        <small>Puedes cambiarlo cuando quieras</small>
      </div>
    </div>

    <label class="chkline" *ngIf="!esAltaCreador && !esAltaAdmin && role === 'usuario'">
      <input type="checkbox" [(ngModel)]="vip" name="vip"> ¬øQuiere ser VIP?
    </label>

    <label class="chkline terms" *ngIf="!esAltaCreador && !esAltaAdmin">
      <input type="checkbox" [(ngModel)]="termsAccepted" name="termsAccepted" required>
      Acepto los <a href="#">T√©rminos</a> y la <a href="#">Pol√≠tica de Privacidad</a> *
    </label>

    <div class="footnote">* Campos obligatorios</div>

    <button class="btn"
      type="submit"
      [disabled]="
        isLoading || f.invalid ||
        (showPasswordFields && (pwdIssues.length>0 || pwdMismatch || (pwnedCount ?? 0) > 0)) ||
        ((!esAltaCreador && !esAltaAdmin) && fechaInvalida) ||
        ((!esAltaCreador && !esAltaAdmin) && !termsAccepted) ||
        !selectedAvatar ||
        !alias || aliasUnique !== true ||
        (isGestor && (!descripcion.trim() || !especialidad.trim() || !(tipoContenido==='Audio' || tipoContenido==='Video'))) ||
        (esAltaAdmin && !departamento?.trim())
      ">
      <span *ngIf="!isLoading">{{ esAltaAdmin || esAltaCreador ? 'Crear' : 'Registrar' }}</span>
      <span *ngIf="isLoading" class="spinner"></span>
    </button>
  </form>
</div>

<!-- Modal Avatares -->
<div
  *ngIf="showAvatarModal"
  class="avatar-modal"
  tabindex="0"
  (click)="closeAvatarModal()"
  (keydown.enter)="closeAvatarModal()"
  (keydown.space)="closeAvatarModal()"
  (keydown.escape)="closeAvatarModal()">

  <div
    class="avatar-modal-content"
    role="dialog"
    aria-modal="true"
    aria-labelledby="avatarTitle"
    (click)="$event.stopPropagation()">

    <div class="avatar-modal-header">
      <h3 id="avatarTitle">{{ (esAltaAdmin || esAltaCreador) ? 'Elige un avatar' : 'Elige tu avatar' }}</h3>
      <button class="avatar-close" type="button" aria-label="Cerrar" (click)="closeAvatarModal()">‚úï</button>
    </div>

    <div class="avatar-preview" *ngIf="selectedAvatar; else noPreview">
      <img [src]="selectedAvatar" alt="avatar seleccionado">
      <div class="avatar-preview__caption">Seleccionado</div>
    </div>
    <ng-template #noPreview>
      <div class="avatar-preview avatar-preview--placeholder">
        <span>Selecciona uno de la galer√≠a</span>
      </div>
    </ng-template>

    <ul class="avatar-grid">
      <li *ngFor="let avatar of avatars"
          class="avatar-option"
          [class.selected]="selectedAvatar === avatar">
        <button type="button"
                (click)="selectAvatar(avatar)"
                (keydown.enter)="selectAvatar(avatar)"
                [attr.aria-pressed]="selectedAvatar === avatar"
                [attr.aria-label]="'Elegir avatar ' + avatar">
          <img [src]="avatar" alt="avatar">
          <span class="avatar-check">‚úì</span>
        </button>
      </li>
    </ul>

    <div class="avatar-modal-actions">
      <button class="btn btn--ghost" type="button" (click)="closeAvatarModal()">Cancelar</button>
    </div>
  </div>
</div>
